<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reset Password — ReDiscoverU</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    body { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; }
    .reset-box { width: 100%; max-width: 420px; }
    .otp-input { text-align: center; letter-spacing: 0.4em; font-size: 1.4rem; font-family: var(--mono); }
    .step { display: none; } .step.active { display: block; }
  </style>
</head>
<body>

<div class="reset-box">
  <a href="login.html" style="display:block; margin-bottom:2rem;"><span class="caption" style="color:var(--text-3);">← Back to Sign In</span></a>

  <!-- Step 1 -->
  <div class="step active" id="s1">
    <div class="caption">Account Recovery</div>
    <div class="gold-line"></div>
    <h2 style="font-size:1.8rem; font-weight:300; margin-bottom:0.5rem;">Reset Password</h2>
    <p style="font-size:0.85rem; color:var(--text-3); margin-bottom:2rem;">Enter your email and we'll send a verification code.</p>
    <div id="a1"></div>
    <div class="form-group"><label>Email Address</label><input type="email" id="fp-email" placeholder="you@example.com"></div>
    <button class="btn btn-outline btn-full" onclick="sendOtp()"><span>Send Code</span></button>
  </div>

  <!-- Step 2 -->
  <div class="step" id="s2">
    <div class="caption">Verify</div>
    <div class="gold-line"></div>
    <h2 style="font-size:1.8rem; font-weight:300; margin-bottom:0.5rem;">Enter Code</h2>
    <p style="font-size:0.85rem; color:var(--text-3); margin-bottom:2rem;">Check your email for the 6-digit reset code.</p>
    <div id="a2"></div>
    <div class="form-group"><label>Reset Code</label><input type="text" class="otp-input" id="fp-otp" placeholder="000000" maxlength="6"></div>
    <button class="btn btn-outline btn-full" onclick="verifyCode()"><span>Continue</span></button>
  </div>

  <!-- Step 3 -->
  <div class="step" id="s3">
    <div class="caption">New Password</div>
    <div class="gold-line"></div>
    <h2 style="font-size:1.8rem; font-weight:300; margin-bottom:0.5rem;">Set New Password</h2>
    <p style="font-size:0.85rem; color:var(--text-3); margin-bottom:2rem;">Choose a strong password for your account.</p>
    <div id="a3"></div>
    <div class="form-group"><label>New Password</label><input type="password" id="new-pw" placeholder="Minimum 8 characters"></div>
    <div class="form-group"><label>Confirm Password</label><input type="password" id="confirm-pw" placeholder="Repeat password"></div>
    <button class="btn btn-outline btn-full" onclick="resetPw()"><span>Reset Password</span></button>
  </div>
</div>

<script src="assets/js/utils.js"></script>
<script>
  let fpEmail = '', fpOtp = '';

  function goTo(n) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('s' + n).classList.add('active');
  }

  async function sendOtp() {
    const email = document.getElementById('fp-email').value.trim();
    clearAlert('a1');
    if (!email) { showAlert('a1', 'Please enter your email.'); return; }
    try {
      await fetch(`${API}/auth/forgot-password`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      fpEmail = email;
      showAlert('a1', 'If that account exists, a reset code has been sent.', 'info');
      setTimeout(() => goTo(2), 1200);
    } catch (e) { console.error("[error]", e); showAlert('a1', 'Connection error.'); }
  }

  function verifyCode() {
    fpOtp = document.getElementById('fp-otp').value.trim();
    clearAlert('a2');
    if (!fpOtp || fpOtp.length !== 6) { showAlert('a2', 'Please enter the 6-digit code.'); return; }
    goTo(3);
  }

  async function resetPw() {
    const newPassword = document.getElementById('new-pw').value;
    const confirm     = document.getElementById('confirm-pw').value;
    clearAlert('a3');
    if (!newPassword || newPassword.length < 8) { showAlert('a3', 'Password must be at least 8 characters.'); return; }
    if (newPassword !== confirm) { showAlert('a3', 'Passwords do not match.'); return; }

    try {
      const res = await fetch(`${API}/auth/reset-password`, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email: fpEmail, otp: fpOtp, newPassword })
      });
      const data = await res.json();
      if (!res.ok) { showAlert('a3', data.error || 'Reset failed.'); return; }
      showAlert('a3', '✓ Password reset successfully. Redirecting…', 'success');
      setTimeout(() => window.location.href = 'login.html', 1800);
    } catch (e) { console.error("[error]", e); showAlert('a3', 'Connection error.'); }
  }
</script>
</body>
</html>
